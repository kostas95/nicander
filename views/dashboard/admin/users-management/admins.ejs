<style>
    input,
    select {
        width: 15vw !important;
        margin: 10px !important;
    }

    .last {
        width: 14vw;
    }

    .data-cont-head>h2 {
        width: 10vw;
    }

    .data-cont:nth-child(2n) {
        background-color: rgb(238, 238, 238) !important;
    }

    .data-cont:nth-child(2n+1) {
        background-color: #fff !important;
    }

    .data {
        width: 10vw;
    }

    #input-container {
        margin-bottom: 1rem;
    }

    .fa-circle-o-notch {
        margin: 3rem;
    }

    h5 {
        text-align: center;
        font-weight: lighter;
        min-width: 5vw;
        padding: 10px;
    }

    .width-100 {
        align-items: flex-start;
    }

    #container {
        padding-top: 1rem;
    }

    #street,
    #telephone,
    #name {
        display: none;
    }

    .button-4 {
        width: 140px !important;
        font-size: 1rem;
        color: #6D326D;
        background-color: #fff;
        border: 1px solid #6d326d;
    }

    label {
        text-align: center;
    }

    .form-cont {
        display: none;
    }

    .fa-check,
    .fa-check::before {
        display: flex;
        justify-content: center;
        align-items: center;
        color: #fff;
    }

    #check {
        width: 1rem !important;
        height: 1rem !important;
    }

    @media only screen and (max-width: 1024px) and (max-height: 1366px) {
        .button-4 {
            flex: 1;
        }

        .padding-2rem {
            padding: 1rem;
        }

        .flex-dir-row {
            flex-direction: column !important;
        }

        @media only screen and (min-width: 833px) and (max-height: 1366px) {
            #container * {
                font-size: 14px;
            }
        }

        #buttons-cont {
            flex-direction: row !important;
        }

        #buttons-cont:nth-child(2) {
            width: 50% !important;
        }

        .dashboard-headers {
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .filter-container,
        .filter-container>.container,
        #input-container {
            width: 100% !important;
        }

        #input-container>.container {
            flex-direction: row !important;
        }

        .button-3 {
            width: 70px !important;
            font-size: 9px;
            margin: 2px;
        }

        input,
        select {
            width: 80% !important;
        }

        .width-75 {
            width: 100% !important;
            flex: none;
        }

        .data-cont-head {
            flex-direction: row !important;
            width: 100% !important;
        }

        #container,
        #container>.container {
            width: 100%;
        }

        .margin-right-25px {
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .margin-left-2rem {
            margin: 0;
        }

        label {
            text-align: center;
        }

        .heading {
            display: none;
        }

        .data-cont {
            padding: 0;
            flex-direction: row !important;
        }

        .data-cont>.container {
            flex-direction: row !important;
            flex-wrap: wrap !important;
            margin: 5px;
        }

        .data:nth-child(3),
        .data:nth-child(4) {
            display: none;
        }

        .data {
            padding: 0 !important;
            font-size: 12px;
            margin: 0;
            flex: 1;
        }

        .del_btn, .change_pwd {
            padding: 5px 0 !important;
        }

        .filter-container {
            border: none;
        }
    }

    @media only screen and (max-width: 280px) and (max-height: 653px) {
        #input-container>.container {
            flex-direction: column !important;
        }

        .padding-2rem {
            padding: 0;
        }

        .data:nth-child(3),
        .data:nth-child(4),
        .data:nth-child(5),
        .data:nth-child(6),
        .data:nth-child(7),
        .data:nth-child(8) {
            display: none;
        }
    }
</style>

<div class="dashboard-container">
    <div class="container flex-dir-row padding-2rem" id="buttons-cont">
        <a href="/dashboard/users-management/doctors">
            <div class="dashboard-headers"><i class="fas fa-user-nurse"></i>Doctors</div>
        </a>
        <a href="/dashboard/users-management/system-doctors">
            <div class="dashboard-headers"><i class="fas fa-user-md"></i>System doctors</div>
        </a>
        <a href="/dashboard/users-management/patients">
            <div class="dashboard-headers"><i class="fas fa-user"></i>Patients</div>
        </a>
        <a href="/dashboard/users-management/admins">
            <div class="dashboard-headers" id="underline"><i class="fas fa-user-cog"></i></i>Admins</div>
        </a>
    </div>
    <h2 class="h2-bg"><i class="fas fa-user-cog"></i></i>
        <div id="h2-txt">Manage Admins</div>
    </h2>
    <div class="container flex-dir-row width-100">
        <div class="container filter-container">
            <div class="container flex-dir-row" id="buttons-cont">
                <button class="button-3 button-4">Manage Admins</button>
                <button class="button-3 button-4">Add Admin</button>
            </div>
            <div class="container">
                <div class="container find-by" id="input-container">
                    <h5>Find by:</h5>
                    <div class="container flex-dir-row">
                        <button class="button button-3" id="mail">Email</button>
                        <button class="button button-3" id="nam">Full Name</button>
                    </div>
                    <input type="text" placeholder="Find by email" id="email">
                    <input type="text" placeholder="Find by full name" id="name">
                    <input type="text" placeholder="Find by street number" id='street'>
                    <input type="text" placeholder="Find by telephone number" id="telephone">
                </div>
                <div class="container order-by" id="input-container">
                    <h5>Order by:</h5>
                    <select value>Order by:
                        <option value="Registration date" id="registration_date">Registration date</option>
                        <option value="Email alphabetically" id="email_alphabetically">Email alphabetically</option>
                        <option value="First name alphabetically" id="fname_alphabetically">First name alphabetically
                        </option>
                        <option value="Last name alphabetically" id="lname_alphabetically">Last name alphabetically
                        </option>
                    </select>
                </div>
            </div>
        </div>
        <div class="container margin-left-2rem width-75">
            <div class="container width-75 padding-1rem">
                <div class="container" id="container">
                    <div class="container flex-dir-row">
                        <div class="message-log2">
                            <%= msg2 %>
                        </div>
                        <div class="message-log">
                            <%= error2 %>
                        </div>
                    </div>
                    <div class="container">
                        <div class="container flex-dir-row data-cont-head">
                            <h2 class='heading'>Registration Date</h2>
                            <h2 class='heading'>Email</h2>
                            <h2 class='heading'>Name</h2>
                            <h2 class='heading'>Surname</h2>
                            <h2 class='heading'></h2>
                        </div>
                        <!-- <i class="fa fa-circle-o-notch fa-spin" style="font-size:5rem"></i> -->
                    </div>
                </div>
            </div>
            <div class="container padding-1rem form-cont">
                <form action="/dashboard/users-management/admins" method="post" class="form container"
                    autocomplete="off">
                    <!-- <div class="container flex-dir-row"> -->
                    <div class="container">
                        <label>First Name</label>
                        <input type="text" id="name_" class='input-field width-100' name="name" value="">
                    </div>
                    <div class="container">
                        <label>Surname</label>
                        <input type="text" id="surname" class='input-field width-100' name="surname" value="">
                    </div>
                    <!-- </div> -->
                    <!-- <div class="container flex-dir-row width-99"> -->
                    <div class="container width-99">
                        <label class="width-99">Email</label>
                        <input type="email" id="e-mail" class='input-field width-100' name='email' value="">
                    </div>
                    <!-- </div> -->
                    <!-- <div class="container flex-dir-row"> -->
                    <div class="container">
                        <label>Password</label>
                        <input type="password" id="password" name='password' class='input-field width-100' value="">
                    </div>
                    <div class="container">
                        <label>Confirm Password</label>
                        <input type="password" id="c_password" name="c_password" class='input-field width-100' value="">
                    </div>
                    <div class="container">
                        <input type="submit" value="Register" class="button">
                        <div class="message-log">
                            <%= error %>
                        </div>
                        <div class="message-log2">
                            <%= msg %>
                        </div>
                    </div>
                    <!-- </div> -->
                </form>
            </div>
        </div>
    </div>
</div>
<script>

    //Prevent form from resubmitting when page refreshes
    if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
    }

    const name_ = document.getElementById('name_');
    const surname = document.getElementById('surname');
    const e_mail = document.getElementById('e-mail');
    const password = document.getElementById('password');
    const c_password = document.getElementById('c_password');
    const message = document.getElementsByClassName('message-log')[1]

    const manageAdmins = document.getElementsByClassName('button-4')[0];
    const addAdmin = document.getElementsByClassName('button-4')[1];

    const container = document.querySelector('#container');
    const formContainer = document.querySelector('.form-cont');

    const error = `<%= error %>`;
    const error2 = `<%= error2 %>`;
    const msg = `<%= msg %>`;
    const msg2 = `<%= msg2 %>`;
    // console.log(error, error2, msg, msg2)

    if (error || error2 || msg || msg2) {
        container.style.display = 'none';
        formContainer.style.display = 'block';
        document.querySelector('#h2-txt').innerText = 'Add doctor'
    }

    // Event Listener for Manage Admins Button
    manageAdmins.addEventListener('click', () => {
        container.style.display = 'block';
        formContainer.style.display = 'none';
        document.querySelector('#h2-txt').innerText = 'Manage Admins'
    })

    // Event Listener for Add Admin Button
    addAdmin.addEventListener('click', () => {
        container.style.display = 'none';
        formContainer.style.display = 'block';
        document.querySelector('#h2-txt').innerText = 'Add Admin'
    })

    //Buttons choose filter
    const mail_btn = document.querySelector('#mail');
    const name_btn = document.querySelector('#nam');

    //Array for doctor users
    let adminArr = [];

    //Fetch get admins
    fetch("/getUsers/admin", {
        method: "post",
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },

        //make sure to serialize your JSON body
        body: JSON.stringify({
            usertype: 'admin'
        })
    })
        .then(response => response.json())
        .then((body) => {
            body.forEach(element => {
                adminArr.push(element)
            });
        });

    //Create data row for each doctor and display it
    resetToInitial()

    //Input fields filters
    const email = document.querySelector('#email');
    const name = document.querySelector('#name');

    //Event listeners for each button
    mail_btn.addEventListener('click', () => {
        resetToInitial()
        displayNone(name);
        displayNone(street);
        displayNone(telephone);
        displayBlock(email);
    })

    name_btn.addEventListener('click', () => {
        resetToInitial()
        displayNone(email);
        displayNone(street);
        displayNone(telephone);
        displayBlock(name);
    })

    //Event listeners for input fields

    //Email
    email.addEventListener('keyup', () => {
        let found = false;
        removeElements('data-cont');
        if (email.value === '') {
            adminArr.forEach(element => {
                adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
            });
        }
        else {
            adminArr.forEach(element => {
                if (element.email.includes(email.value)) {
                    adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
                    found = true
                }
            });
            if (found === false) {
                removeElements('data-cont');
                const parent = document.createElement('div');
                parent.className = 'container data-cont msg';

                const element = document.createElement('div');
                element.className = 'container flex-dir-row padding-1rem';
                element.style.flexWrap = 'wrap';
                element.innerHTML = `No admins found with the provided criteria`
                element.style.fontSize = `20px`

                // const container = document.querySelector('#container');
                parent.appendChild(element);
                container.appendChild(parent);
            }
        }
    })

    //Full name
    name.addEventListener('keyup', () => {
        let found = false;
        removeElements('data-cont');
        if (name.value === '') {
            adminArr.forEach(element => {
                adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
            });
        }
        else {
            // removeElements('data-cont');
            adminArr.forEach(element => {
                if (element.name.includes(name.value) || element.surname.includes(name.value)) {
                    adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
                    found = true
                }
            });
            if (found === false) {
                removeElements('data-cont');
                const parent = document.createElement('div');
                parent.className = 'container data-cont msg';

                const element = document.createElement('div');
                element.className = 'container flex-dir-row';
                element.style.flexWrap = 'wrap';
                element.innerHTML = `No admins found with the provided criteria`
                element.style.fontSize = `20px`

                // const container = document.querySelector('#container');
                parent.appendChild(element);
                container.appendChild(parent);
            }
        }
    })

    //Sort admins
    //Event listeners for select options
    const registrationDate = document.getElementById('registration_date');
    const authorization = document.getElementById('authorization');
    const emailAlphabetically = document.getElementById('email_alphabetically');
    const fnameAlphabetically = document.getElementById('fname_alphabetically');
    const lnameAlphabetically = document.getElementById('lname_alphabetically');


    //Event listener for select
    var option = document.querySelector('select');
    option.addEventListener('change', function () {
        if (this.value === 'Registration date') {
            adminArr.sort(function (a, b) { return (a.date > b.date) ? 1 : ((b.date > a.date) ? -1 : 0); });
            removeElements('data-cont');
            adminArr.forEach(element => {
                adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
            });
        }
        else if (this.value === 'Authorization') {
            adminArr.sort(function (a, b) { return (a.authorized > b.authorized) ? 1 : ((b.authorized > a.authorized) ? -1 : 0); });
            removeElements('data-cont');
            adminArr.forEach(element => {
                adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
            });
        }
        else if (this.value === 'Email alphabetically') {
            adminArr.sort(function (a, b) { return (a.email > b.email) ? 1 : ((b.email > a.email) ? -1 : 0); });
            removeElements('data-cont');
            adminArr.forEach(element => {
                adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
            });
        }
        else if (this.value === 'First name alphabetically') {
            adminArr.sort(function (a, b) { return (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0); });
            removeElements('data-cont');
            adminArr.forEach(element => {
                adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
            });
        }
        else if (this.value === 'Last name alphabetically') {
            adminArr.sort(function (a, b) { return (a.surname > b.surname) ? 1 : ((b.surname > a.surname) ? -1 : 0); });
            removeElements('data-cont');
            adminArr.forEach(element => {
                adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
            });
        }
    }, false);

    //Delete button functionality
    const parentElement = document.querySelector('.width-75');

    parentElement.addEventListener('click', (e) => {
        if (e.target.className.includes('del_btn')) {
            e.target.style.display = 'none';
            e.target.nextSibling.style.display = 'block';

            setTimeout(function () {
                if (e.target && e.target.nextSibling) {
                    e.target.style.display = 'block';
                    e.target.nextSibling.style.display = 'none';
                }
            }, 5000);

            parentElement.addEventListener('click', (e) => {
                if (e.target.className.includes('confirm')) {
                    //Fetch get doctors
                    fetch("/delUser", {
                        method: "post",
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },

                        //make sure to serialize your JSON body
                        body: JSON.stringify({
                            id: e.target.id
                        })
                    })
                        .then(response => response.json())
                        .then((body) => {
                            console.log(body)
                            e.target.parentElement.innerHTML = `
                            <div class='container  flex-dir-row padding-1rem width-100'>
                                <div style='padding:5px'>${body.msg}</div>
                                <div id='check' class='container'>
                                    <i class="fas fa-check"></i>    
                                </div>
                            </div>
                            `;
                        });
                }
            })
        }
    })

    document.querySelector('form').addEventListener('submit', (e) => {

        if (name_.value === '' || surname.value === '' || e_mail.value === '' || password.value === '' || c_password.value === '') {
            if (name_.value === '') {
                styleBorder(name_, 'red')
            }
            else {
                styleBorder(name_, 'rgb(226, 226, 226)')
            }
            if (surname.value === '') {
                styleBorder(surname, 'red')
            }
            else {
                styleBorder(surname, 'rgb(226, 226, 226)')
            }
            if (e_mail.value === '') {
                styleBorder(e_mail, 'red')
            }
            else {
                styleBorder(e_mail, 'rgb(226, 226, 226)')
            }
            if (password.value === '') {
                styleBorder(password, 'red')
            }
            else {
                styleBorder(password, 'rgb(226, 226, 226)')
            }
            if (c_password.value === '') {
                styleBorder(c_password, 'red')
            }
            else {
                styleBorder(c_password, 'rgb(226, 226, 226)')
            }
            message.style.display = 'block';
            message.innerText = 'Please fill all fields correctly!'
            e.preventDefault()
        }
        else if (password.value !== c_password.value) {
            styleBorder(password, 'red')
            styleBorder(c_password, 'red')
            message.style.display = 'block';
            message.innerText = 'Password and password confirmation do not match!'
            inputFieldsNormalColor()
            e.preventDefault()
        }
        else if (password.value.length < 5) {
            styleBorder(password, 'red')
            styleBorder(c_password, 'red')
            message.innerText = 'Password must be at least 5 characters'
            inputFieldsNormalColor()
            e.preventDefault()
        }
        else {
            true
        }
    })


    function adminElement(id, date, email, name, surname, dd, mm, yy, authorized) {
        const userEmail = document.querySelector('.email').innerText
        const parent = document.createElement('div');
        parent.className = 'container data-cont';

        const element = document.createElement('div');
        element.className = 'container flex-dir-row';
        element.style.flexWrap = 'wrap';

        if (email !== userEmail) {
            element.innerHTML = `
            <div class='data'>${date.substring(0, 10)}</div> 
            <div class='data'>${email}</div>
            <div class='data'>${name}</div>
            <div class='data'>${surname}</div>
            <button class='data del_btn' id='${id}'>Delete</div>
            <button style = 'display:none' class='data confirm' id='${id}'>Are you sure?</button>
            `
        }
        else {
            element.innerHTML = `
            <div class='data'>${date.substring(0, 10)}</div> 
            <div class='data'>${email}</div>
            <div class='data'>${name}</div>
            <div class='data'>${surname}</div>
            <button class='data change_pwd' id='${id}'>Change password</button>
            `
        }

        // const container = document.querySelector('#container');
        parent.appendChild(element);
        container.appendChild(parent);
    }

    function removeElements(className) {
        const elements = document.getElementsByClassName(className);
        let arr = Array.from(elements);
        arr.forEach(element => {
            element.remove()
        })
    }

    function displayNone(element) {
        element.style.display = 'none';
    }

    function displayBlock(element) {
        element.style.display = 'block';
    }

    function createSpinner() {
        const spinner = document.createElement('i');
        spinner.className = 'fa fa-circle-o-notch fa-spin'
        spinner.style = 'font-size:5rem'

        document.querySelector('.data-cont-head').parentElement.appendChild(spinner)
    }

    function resetToInitial() {
        disableButtons()
        createSpinner();
        removeElements('data-cont');
        setTimeout(function () {
            enableButtons()
            document.querySelector('.fa-circle-o-notch').remove()
            adminArr.forEach(element => {
                adminElement(element._id, element.date, element.email, element.name, element.surname, element.dd, element.mm, element.yy, element.authorized)
            });

            //Change Password

            //Button event listener

            //Create modal
            const changePwBtn = document.querySelector('.change_pwd');
            changePwBtn.addEventListener('click', (e) => {
                const modal = document.createElement('div');
                modal.className = 'modal container';

                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content container';
                modalContent.innerHTML = `
                <span class="close container"><i class="fas fa-times"></i></span>

                <form action="/dashboard/users-management/admins" method="post" class="form container"
                    autocomplete="off" id='update-form'>
                    <h2>Change your password</h2><br><br>
                    <div class="container">
                        <label>New Password</label>
                        <input type="password" id="password" name='new_password' class='input-field width-100' value="">
                    </div>
                    <div class="container">
                        <label>Confirm Password</label>
                        <input type="password" id="c_password" name="c_password" class='input-field width-100' value="">
                    </div>
                        <input style='display:none' type="password" id="id" name="id" class='input-field width-100' value="${e.target.id}">
                    <div class="container">
                        <input type="submit" value="Update" class="button">
                    </div>
                </form>
            `

                modal.appendChild(modalContent);
                document.querySelector('body').appendChild(modal)

                document.querySelector('body').addEventListener('click', (e) => {
                    if (e.target.classList.contains('fas') || e.target.classList.contains('modal'))
                        modal.remove()
                })
            })
        }, 1000);
    }

    function disableButtons() {
        mail_btn.disabled = true;
        name_btn.disabled = true;
    }

    function enableButtons() {
        mail_btn.disabled = false;
        name_btn.disabled = false;
    }

    function styleBorder(field, color) {
        field.style.border = `1px solid ${color}`
    }

    function inputFieldsNormalColor() {
        styleBorder(name, 'rgb(226, 226, 226)')
        styleBorder(surname, 'rgb(226, 226, 226)')
        styleBorder(email, 'rgb(226, 226, 226)')
    }

</script>